<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Пользователи — Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
    h1{margin:0 0 16px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}
    th{background:#f3f4f6}
    .muted{color:#6b7280}
    .err{color:#c00;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Зарегистрированные пользователи</h1>
  <table id="tbl">
    <thead>
      <tr><th>ID</th><th>Имя</th><th>Email</th><th>Дата регистрации</th></tr>
    </thead>
    <tbody><tr><td colspan="4">Загрузка…</td></tr></tbody>
  </table>

  <script>
    // Работает и при file:// и при http://localhost:8000
    const ORIGIN = location.origin.startsWith('http')
      ? location.origin
      : 'http://localhost:8000';

    async function load(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '<tr><td colspan="4">Загрузка…</td></tr>';

      try{
        const r = await fetch(`${ORIGIN}/api/users_list.php`, {cache:'no-store'});
        const txt = await r.text();  // читаем как текст, чтобы показать, если это HTML-ошибка
        let data;
        try { data = JSON.parse(txt); }
        catch(e){
          tbody.innerHTML = `<tr><td colspan="4" class="err">
            Не JSON от API. Ответ сервера:\n\n${txt.slice(0,2000)}
          </td></tr>`;
          return;
        }

        if (!data.ok){
          tbody.innerHTML = `<tr><td colspan="4" class="err">
            API error: ${data.error || 'неизвестно'}
          </td></tr>`;
          return;
        }

        const items = data.items || [];
        if (items.length === 0){
          tbody.innerHTML = `<tr><td colspan="4" class="muted">Пользователей пока нет</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        for (const u of items){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.name || '<span class="muted">—</span>'}</td>
            <td>${u.email}</td>
            <td>${u.created_at}</td>
          `;
          tbody.appendChild(tr);
        }
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="4" class="err">Ошибка загрузки: ${e}</td></tr>`;
      }
    }
    load();
  </script>
</body>
</html>